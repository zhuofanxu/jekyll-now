## 合约基础

### 合约地址

    合约地址通过 sha3(creator, transaction_nonce)计算出

## 合约安全

### Re-Entrancy 

    攻击者通过恶意合约代码调用脆弱的业务合约，利用合约收款 fallback 特性
    不断的在攻击合约和业务合约重入，直到达到攻击者设定的条件。

    预防方法：
    1) 当给外部地址(很有可能是外部合约地址)转ether时，使用内部方法 transfer()
    因为该方法仅支持(发送) 2300gas 供外部合约调用(如果接收对象是外部合约的话)
    这些 gas 不足以让外部合约再发起一次业务合约的调用(i.e. 重入业务合约)

    2)  checks-effects-interactions 发送ether 之前先改变状态变量

    3) 加锁 额外增加一个状态变量 发送ether 之前改变锁变量状态

### 算术溢出/下溢

    溢出(上溢) uint8 257 --> 1
    下溢 uint 0 - 1 --> 255
    SafeMath

### Unexpected Ether

    selfdestruct(addr_target) 合约销毁后 会把合约账户中的所有ether 发送到 addr_target 如果目标地址是个合约地址，则不会执行该合约中的任何代码(包括 fallback 方法)
    业务合约中在用到 address(this).balance 需要特别注意 因为恶意攻击合约可能会通过
    自我销毁来向我们的业务合约发送ether 这发送过来的ether 对业务合约来说就是未预期的
    ether, 极有可能造成业务逻辑的混乱。

    预防方法：
    使用额外的变量跟踪合约中ether，避免使用address(this).balance
    
## 合约ABI编码规范

    应用二进制接口Application Binary Interface(ABI) 是从区块链外部与合约进行交互以及合约与合约间进行交互的一种标准方式。

    进行合约调用时需要将其输入数据(包括方法签名、方法参数)进行ABI编码，
    方法签名的编码是固定的： 对方法签名sha3后 取前四个字节

    对应参数值的编码分两类：
    bytes string T[](变长数租) (包括bytes string 类型的定长数组) 使用头尾编码的方式
    即头部 数据内容起始位置的偏移量
    尾部 包括(数租元素、字符长度 + 实际的元素、字符串编码内容----32字节16进制字符串表示)

    普通类型直接编码 不足32字节的左边补0

    用参数 (0x123, [0x456, 0x789], "1234567890", "Hello, world!") 对 f(uint,uint32[],bytes10,bytes) 的调用会通过以下方式进行编码：
    // 第一个参数普通类型 直接编码 uint<x> 左边32字节补齐
    0x0000000000000000000000000000000000000000000000000000000000000123
    // 第二个参数的数据部分起始位置的偏移量，4*32 字节，正好是头部的大小 
    // 非普通类型的头部编码部分
    0x0000000000000000000000000000000000000000000000000000000000000080
    // 第三个参数普通类型 直接编码 bytes<M> 右边32字节补齐
    0x3132333435363738393000000000000000000000000000000000000000000000
    // 第四个参数数据部分起始位置的偏移量
    // 非普通类型的头部编码部分
    0x00000000000000000000000000000000000000000000000000000000000000e0

    在此之后，跟着第一个动态参数的数据部分 [0x456, 0x789]：
    // 数组元素个数，2
    0x0000000000000000000000000000000000000000000000000000000000000002 
    // （第一个数组元素）   
    0x0000000000000000000000000000000000000000000000000000000000000456 
    //（第二个数组元素）
    0x0000000000000000000000000000000000000000000000000000000000000789 

    // 我们将第二个动态参数的数据部分 "Hello, world!" 编码
    // 字符数量(字节数)
    0x000000000000000000000000000000000000000000000000000000000000000d
    // 右边32字节补齐
    0x48656c6c6f2c20776f726c642100000000000000000000000000000000000000